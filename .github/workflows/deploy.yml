name: Build and Deploy Function App

on:
    push:
        branches:
            - main

jobs:

  deploy-infra:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
        
      - name: Deploy Bicep Template
        run: |
          az deployment sub create \
            --location WestUS \
            --template-file ./infra/main.bicep \
            --parameters functionAppName=eventbasedAPI-App

  build-and-deploy:
      needs: deploy-infra
      runs-on: ubuntu-latest

      steps:
          - name: Checkout code
            uses: actions/checkout@v3
            
          - name: Setup NET
            uses: actions/setup-dotnet@v4
            with:
              dotnet-version: '8.0.x'
          
          - name: Restore and Build Function App
            run: dotnet publish ./src/<your-func-folder>.csproj -c Release -o ./publish

          - name: Deploy to Azure Function App
            uses: Azure/functions-action@v1
            with:
              app-name: eventbasedAPI-App
              package: ./publish
              publish-profile: ${}